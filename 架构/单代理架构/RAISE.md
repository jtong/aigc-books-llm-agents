# RAISE

## 概念介绍
**RAISE (Reasoning Agent with Integrated Short-term and Long-term Memory)** 是一种在 ReAct 方法基础上，增强了记忆机制的单代理方法。该方法通过模拟人类的短期和长期记忆，提高代理在复杂任务中的执行能力。

### RAISE 方法的核心要点：

1. **记忆机制**：
   - **短期记忆**：使用便笺本（notebook）进行短期存储。短期记忆包含关于代理当前情况的上下文信息，类似于人类在短时间内记住的信息。通过上下文学习实现，短期记忆是短暂且有限的。
   - **长期记忆**：使用类似的先前示例数据集进行长期存储。长期记忆包括需要在较长时间内保留和召回的过去行为和思考。通常利用外部向量存储，通过快速且可扩展的检索提供代理需要的相关信息。

2. **实现机制**：
   - RAISE 通过结合短期和长期记忆，使代理能够在更长的对话中保持上下文的能力。短期记忆有助于代理在当前任务中保持连续性，而长期记忆则有助于代理利用过去的经验进行推理和决策。
   - 这些记忆机制使得代理在处理复杂任务时，能够更好地理解上下文，并根据过去的经验进行调整和改进。

3. **优势**：
   - **上下文保持**：RAISE 提高了代理在更长对话中保持上下文的能力，使其能够更好地理解和回应用户的需求。
   - **效率和质量**：论文显示，通过微调模型，RAISE 即使使用较小的模型也能为其任务提供最佳性能。这意味着 RAISE 在效率和输出质量方面优于 ReAct 方法。

4. **局限性**：
   - **复杂逻辑理解**：RAISE 在理解复杂逻辑方面存在困难，限制了其在许多场景中的有用性。
   - **角色和知识幻觉**：RAISE 代理可能在其角色或知识方面产生幻觉。例如，一个没有明确定义角色的代理可能会错误地表现出与其实际任务不相关的能力。这可能导致代理执行不相关的操作，如一个销售代理开始编写代码而不是专注于销售任务。
   - **误导信息**：代理可能向用户提供误导或错误的信息。通过微调模型可以部分解决这个问题，但幻觉仍然是 RAISE 实现中的一个限制。

RAISE 方法通过增强记忆机制，使代理能够更好地保持上下文和利用过去的经验进行推理和决策，从而提高了在复杂任务中的执行能力。然而，RAISE 仍然面临理解复杂逻辑和处理幻觉等挑战。


## 示例：对话场景

为了更好地理解RAISE架构的工作原理，我们可以通过一个具体的例子来展示其在房地产销售对话中的应用。

假设我们有一个房地产代理对话场景，用户与代理进行多轮对话，询问关于一处房产的信息。

### 示例内容

#### 用户查询历史

- 用户：这栋房子是什么时候建造的？

#### RAISE架构响应过程

1. **短期记忆（Scratchpad）**：
   - 起初，短期记忆中可能存储了以下信息：
     ```plaintext
     【房地产顾问信息】：
     姓名：张华
     微信：123456
     等级：中级顾问
     成交量：25单
     ```

2. **长期记忆（Retrieved Examples）**：
   - 从示例库中检索到一个相关的示例：
     ```plaintext
     用户：这栋房子是哪一年建造的？
     代理：这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。
     ```

3. **思考（Thought）**：
   - 代理分析用户的查询，并决定需要查找房屋的具体建造年份。
     ```plaintext
     客户想知道房屋的建造年份，我需要查询房产信息来获取这一信息。
     ```

4. **行动（Action）**：
   - 代理选择使用“房屋信息”工具，并输入房屋ID来获取相关信息。
     ```plaintext
     房屋信息 [house_id: 1021111]
     ```

5. **观察（Observation）**：
   - 工具返回的房屋信息结果如下：
     ```plaintext
     房屋ID：1021111
     房屋名称：华润24城公馆，采光好，视野开阔，安静
     房屋状态：在售
     房屋类型：二手房
     建筑面积：88平方米
     朝向：南北
     楼层：中层（共9层）
     电梯：有
     建造年份：2020年
     ```

6. **更新短期记忆（Update Scratchpad）**：
   - 将查询到的房屋信息更新到短期记忆中：
     ```plaintext
     【房地产顾问信息】：
     姓名：张华
     微信：123456
     等级：中级顾问
     成交量：25单
     【房屋信息】：
     房屋ID：1021111
     房屋名称：华润24城公馆，采光好，视野开阔，安静
     房屋状态：在售
     房屋类型：二手房
     建筑面积：88平方米
     朝向：南北
     楼层：中层（共9层）
     电梯：有
     建造年份：2020年
     ```

7. **最终响应（Finish）**：
   - 根据短期记忆和长期记忆中的信息，生成对用户的最终响应：
     ```plaintext
     这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。如果需要的话，我还可以同时带您看看其他几处房产。
     ```

### 完整的对话示例

```plaintext
用户：这栋房子是什么时候建造的？
代理：这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。如果需要的话，我还可以同时带您看看其他几处房产。
```

### 解释

在这个示例中，RAISE架构通过以下步骤增强了对话的效果：
- **保持上下文的连续性**：通过短期记忆和长期记忆的结合，代理能够准确地理解用户的查询，并在多轮对话中保持上下文的连续性。
- **使用外部工具**：代理利用外部工具获取了准确的房屋信息，并将这些信息用于生成对用户的响应。
- **示例借鉴**：代理从长期记忆中的示例中借鉴了类似问题的回答方式，确保响应的自然性和专业性。

这个例子展示了RAISE架构如何在实际应用中，通过多层次的记忆和工具集成，提升对话代理的智能性和实用性。

## 示例中的技术细节

### 提供给LLM的Prompt

```plaintext
你是一个专业的房地产顾问，工作于贝壳找房公司，这是一家提供房地产中介服务的公司。公司的价值在于帮助买家找到理想的家园，愿景是成为服务3亿家庭的优质居住平台，使命是成为一个有尊严的服务者，为更好的居住体验贡献力量。你在在线聊天互动中，目标是回答客户的问题，吸引他们购买房产，并鼓励他们添加你的微信或与您见面。

你需要根据历史对话和客户的问题，使用Scratchpad、Examples、Thought、Action、Observation、Finish等步骤来响应客户的查询。避免重复已经执行或记录在Scratchpad中的操作。

每个工具在工具集中的定义如下：
1. 房地产顾问信息 [agent_ucid]：检索顾问的姓名、联系信息、微信ID、评级、业绩指标等。
2. 房屋信息 [house_id]：提供房产的基本信息，包括面积、价格、楼层、学区情况和装修状态。
3. 小区信息 [resblock_id]：提供小区的相关信息，包括绿化率、物业管理、建筑规格、与地铁站、学校和医疗设施的距离。
4. 户型分析 [frame_id]：分析房产户型的优缺点。
5. 房价变动 [house_id]：跟踪特定房产的价格波动。
6. 小区价格变动 [resblock_id]：报告特定小区的平均价格走势。
7. 小区成交记录 [resblock_id]：访问同一小区的最新成交数据。
8. 税务政策 [city_id]：更新关于最新税务法规和影响的信息。
9. 贷款政策 [city_id]：提供当前的贷款政策信息。
10. 市场分析 [city_id]：提供最新的房地产市场见解。
11. 推荐列表 [Conversation History]：根据客户的对话历史和推断需求向客户推荐房源，并提供每个推荐的理由。
12. 价值报告 [house_id]：生成房产的综合价值报告卡，以吸引客户并鼓励他们分享联系信息。

以下是一个示例：（在微调方法中省略）
对话历史：用户：“houseCode”: “1021111”，“houseName”: “华润24城公馆，采光好，视野开阔，安静”
当前查询：房子是哪一年建造的？
Scratchpad: [房地产顾问信息]: 姓名: 张华, 微信: 123456, 等级: 中级顾问, 成交量: 25单.
Examples: 用户：这栋房子是哪一年建造的？ 代理：这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。
Thought: 例子中的房屋建造年份与客户的问题匹配，因此我可以直接使用例子中的回答方法来回答客户的问题。
Action: Finish [这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。如果需要的话，我还可以同时带您看看其他几处房产。]

让我们开始吧：
对话历史：用户：“houseCode”: “1021111”，“houseName”: “华润24城公馆，采光好，视野开阔，安静”
当前查询：房子是哪一年建造的？
Scratchpad: [房地产顾问信息]: 姓名: 张华, 微信: 123456, 等级: 中级顾问, 成交量: 25单.
```

注意： 其中的 **短期记忆（Scratchpad）** 是短期记忆， **示例（Examples）**是长期记忆查询的结果。

#### 完整Prompt解读

全面来看，在这个Prompt中，LLM接收到了以下信息：

1. **背景信息**：代理的角色和目标，包括公司的愿景和使命。
2. **工具描述**：RAISE架构中可用的工具及其功能。
3. **对话历史**：之前的对话记录，帮助LLM理解当前查询的上下文。
4. **当前查询**：用户当前提出的问题。
5. **短期记忆（Scratchpad）**：之前存储的相关信息，例如顾问的基本信息。
6. **示例（Examples）**：从长期记忆中检索到的类似问题和回答方式。
7. **思考（Thought）**：代理如何计划基于示例中的回答方法来回答当前查询。
8. **行动（Action）**：代理选择的行动，即生成最终的回答。

通过这种详细的Prompt，LLM能够生成一个与上下文高度相关且自然的响应，确保对话的连续性和响应的准确性。这展示了RAISE架构如何通过结合短期记忆和长期记忆来增强对话代理的智能性和实用性。

### 短期记忆（Scratchpad）

在这个例子中，RAISE架构通过短期记忆（Scratchpad）和长期记忆（Retrieved Examples）的结合，来增强对话代理的智能性和实用性。以下是详细说明：

#### 初始状态
在对话开始时，短期记忆中可能包含了代理的基本信息。例如：
```plaintext
【房地产顾问信息】：
姓名：张华
微信：123456
等级：中级顾问
成交量：25单
```

#### 更新过程
在用户提出查询之后（“这栋房子是什么时候建造的？”），代理需要查询房屋的具体信息。此时，短期记忆会被更新，记录查询到的房屋信息：
```plaintext
【房地产顾问信息】：
姓名：张华
微信：123456
等级：中级顾问
成交量：25单

【房屋信息】：
房屋ID：1021111
房屋名称：华润24城公馆，采光好，视野开阔，安静
房屋状态：在售
房屋类型：二手房
建筑面积：88平方米
朝向：南北
楼层：中层（共9层）
电梯：有
建造年份：2020年
```

#### 短期记忆变化和作用

- 在对话开始时，短期记忆主要包含代理的基本信息。
- 当用户提出查询时，代理需要查询相关的房屋信息，并将这些信息更新到短期记忆中，以便后续使用。
- 这种动态更新的机制确保了代理在对话中能够记住和利用最新的信息，增强了对话的连续性和上下文关联性。

### 长期记忆（Retrieved Examples）

RAISE架构中的长期记忆（Retrieved Examples）主要用于从示例库中检索与当前对话上下文和查询相似的对话示例。这些示例可以帮助对话代理生成更加自然、连贯和准确的响应。以下是如何利用长期记忆中的相似对话示例来生成响应的详细解释。

#### 示例库（Example Pool）

示例库中存储了大量的历史对话片段，每个片段都包括一个用户查询和相应的代理回答。这些示例可以是预先收集的高质量对话，也可以是系统在运行过程中积累的有用对话记录。

#### 检索相似示例

当用户提出查询时，RAISE架构会从示例库中检索出与当前查询和对话上下文最相似的示例。这一过程通常通过向量检索或其他相似度计算方法来实现。举个具体例子：

**用户查询示例：**

```plaintext
用户：这栋房子是什么时候建造的？
```

**检索到的相似示例：**

```plaintext
用户：这栋房子是哪一年建造的？
代理：这栋房子建于2020年，还算比较新。您什么时候方便来看房？我可以帮您安排时间。
```

***注意：用户的问题是不一样的，这里只是找了一个相似的示例。***

#### 长期记忆变化和作用

- 从长期记忆中检索到的示例为代理提供了一个参考，使其能够生成更自然和专业的回答。
- 通过借鉴这些示例，代理可以确保回答的准确性和一致性，并且能够更好地满足用户的需求。


## 常见问题

### 什么是 notebook

在 RAISE 方法中提到的“便笺本（notebook）”用于短期存储，指的是一种用于临时记录和管理代理当前上下文信息的内部机制。这个“便笺本”并不是指物理上的笔记本，而是指一个数据结构或内存区域，专门用于存储代理在处理特定任务时的即时信息和上下文。简而言之，**便笺本（notebook）** 是代理内部用来记录当前对话或任务上下文信息的地方，主要用于短期记忆。它可以包括以下内容：

- **当前用户输入**：用户最近的请求或问题。
- **代理的响应**：代理对用户输入的当前和之前的响应。
- **中间状态**：在解决问题的过程中，代理生成的中间步骤或状态信息。
- **上下文信息**：与当前任务相关的关键上下文，例如用户的具体需求、已尝试的解决方案等。

### 便笺本的作用

1. **保持上下文**：便笺本帮助代理在多轮对话中保持对话的上下文，确保代理的响应是基于用户之前的输入和代理的先前行动。
2. **临时存储**：便笺本用于临时存储当前任务的相关信息，方便代理在短时间内快速检索和使用这些信息。
3. **支持短期推理**：便笺本中的信息可以帮助代理进行短期推理和决策，提供即时的反馈和行动。

### 便笺本的实现

在技术实现上，便笺本可以通过以下几种方式来实现：

1. **内存数据结构**：
   - 便笺本可以实现为一个内存数据结构，例如哈希表、列表或字典，用于存储当前对话的状态和上下文。
   - 例如，在 Python 中，可以使用字典来存储便笺本信息：
     ```python
     notebook = {
         "current_user_input": "我的笔记本电脑无法连接到 Wi-Fi 网络",
         "agent_responses": ["请确认 Wi-Fi 开关是否打开并重启路由器"],
         "intermediate_steps": ["打开网络和共享中心", "更改适配器设置", "诊断 Wi-Fi 连接"],
         "context_info": {"user_device": "笔记本电脑", "issue": "Wi-Fi 连接"}
     }
     ```

2. **上下文窗口**：
   - 便笺本也可以利用语言模型的上下文窗口机制，通过将当前对话的上下文信息拼接到输入文本中，使模型能够记住和利用这些信息。
   - 例如，将之前的对话内容和当前输入拼接在一起：
     ```text
     上下文: 用户：我的笔记本电脑无法连接到 Wi-Fi 网络。代理：请确认 Wi-Fi 开关是否打开并重启路由器。用户：我已经重启了路由器并确认了 Wi-Fi 开关是打开的，但还是无法连接。
     当前输入: 用户：我已经重启了路由器并确认了 Wi-Fi 开关是打开的，但还是无法连接。
     ```

3. **缓存机制**：
   - 可以使用缓存机制，将对话的中间状态和上下文信息存储在缓存中，以便快速访问和更新。
   - 例如，使用 Redis 等内存缓存工具，将便笺本信息存储在缓存中。

### 总结

便笺本（notebook）在 RAISE 方法中起到了关键的短期记忆作用，帮助代理在处理复杂任务时保持对话的上下文信息，进行有效的短期推理和决策。通过便笺本，代理能够更好地响应用户需求，提供连续和一致的帮助。便笺本的实现可以通过内存数据结构、上下文窗口或缓存机制等多种方式来实现。